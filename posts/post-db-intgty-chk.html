<!DOCTYPE html>
<html lang="en"> 
<head>
    <title>DevBlog - Bootstrap 5 Blog Template For Developers</title>
    
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Blog Template">
    <meta name="author" content="Xiaoying Riley at 3rd Wave Media">    
    <link rel="shortcut icon" href="favicon.ico"> 
    
    <!-- FontAwesome JS-->
	<script defer src="assets/fontawesome/js/all.min.js"></script>
    
    <!-- Plugin CSS -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/monokai-sublime.min.css">
    
    <!-- Theme CSS -->  
    <link id="theme-style" rel="stylesheet" href="assets/css/theme-7.css">
    

</head> 

<body>
    
    <header class="header text-center">	    
	    <h1 class="blog-name pt-lg-4 mb-0"><a class="no-text-decoration" href="index_1.html">V Ananda Raj</a></h1>
        
	    <nav class="navbar navbar-expand-lg navbar-dark" >
           
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div id="navigation" class="collapse navbar-collapse flex-column" >
				<div class="profile-section pt-3 pt-lg-0">
				    <img class="profile-image mb-3 rounded-circle mx-auto" src="assets/images/profile.png" alt="image" >			
					
					<div class="bio mb-3">AWS | Linux | Docker | Ansible | Script - Python, Bash<br><a href="blog-post.html">Check my works here!</a></div><!--//bio-->
					<ul class="social-list list-inline py-3 mx-auto">
			            <li class="list-inline-item"><a href="www.linkedin.com/in/ananda-raj-v-aa271412b"><i class="fab fa-linkedin-in fa-fw"></i></a></li>
			            <li class="list-inline-item"><a href="https://github.com/Ananda-Raj"><i class="fab fa-github-alt fa-fw"></i></a></li>
			        </ul><!--//social-list-->
			        <hr> 
				</div><!--//profile-section-->
				
				<ul class="navbar-nav flex-column text-start" style="align-items: center;"">
					<li class="nav-item">
					    <a class="nav-link active" href="index_1.html"><i class="fas fa-home fa-fw me-2"></i>You are at Home! <span class="sr-only">(current)</span></a>
					</li>
					<li class="nav-item">
					    <a class="nav-link" href="about.html"><i class="fas fa-user fa-fw me-2"></i>Know Me</a>
					</li>
					<li class="nav-item">
					    <a class="nav-link" href="blog-post.html"><i class="fas fa-bookmark fa-fw me-2"></i>My Posts</a>
					</li>
				</ul>
				
                <div>
                    <br>
                    <br>
                    <br>
				</div>

				<div class="my-2 my-md-3">
				    <a class="btn btn-primary" href="contact.html" target="_blank">Get in Touch</a>
				</div>
			</div>
		</nav>
    </header>
    
    <div class="main-wrapper">
	    
	    <article class="blog-post px-3 py-5 p-md-5">
		    <div class="container single-col-max-width">
			    <header class="blog-post-header">
				    <h2 class="title mb-2">Bash | Check MySQL Database integrity</h2>
				    <div class="meta mb-3"><span class="date">Published on 1 Feb 2020</span><span class="time">5 min read</span></div>
			    </header>
			    
			    <div class="blog-post-body">
					<!-- image size 600 x 1200 px --> 
				    <figure class="blog-banner">
				        <a href="#"><img class="img-fluid" src="assets/images/blog/blog-post-db-intgty-chk.jpg" alt="image"></a>
				        <figcaption class="mt-2 text-center image-caption">Image Credit: <a class="theme-link" href="simplebackups.com" target="_blank">simplebackups.com edited with photomosh and photopea</a></figcaption>
				    </figure>
				    <p> 
					Check if given compressed MySQL Database dumps are complete.
					<br>
					The script will take the list of one day old databases files (compressed gz) from specified location (/home/mysqlbackup/), first to a file and then loaded to an array. The database is checked for the string "Dump completed on" and then written to a log file. The execution is done as jobs, to enable multiple databases to be checked concurrently, decreasing execution time. (Here the value is 30) All logs are stored in a location (/usr/local/mysql-temp/) and logs older than 5 days are removed. The results are pushed into slack.
					<br>
					Execution time: For 10 1.6GB compressed (gz) database dump files, it will take ~2 minutes when all the 10 are executed concurrently.
					<br>
					You can add a cronjob similar to below to check this regularly.
				    <pre>
					    <code>
0 12 * * * /bin/bash /root/check-db-integrity.sh > /usr/local/mysql-temp/`date "+%d"`-check-db-integrity-execution.log 2> /usr/local/mysql-temp/`date "+%d"`-check-db-integrity-execution-err.log
					    </code>
				    </pre>
					</p>
				    
				    <h3 class="mt-5 mb-3">The Script</h3>
				    <pre>
					    <code>
#!/bin/bash

# Script to check daily database backup integrity
# Author: Ananda Raj
# Date: 31 Jan 2020
# Version 1.31012020


echo "###################################################"
echo "$(date +%H:%M:%S) Execution Started"
echo "###################################################"

##### Create work directory if doesn't exist
if [ ! -f /usr/local/mysql-temp/ ]; then
	echo "$(date +%H:%M:%S) Created work directory /usr/local/mysql-temp/"
        mkdir /usr/local/mysql-temp
fi


##### Checking individual backup files for completion.
check-backup()	
{
	echo "$(date +%H:%M:%S) Entered function check-backup for array index $i and value ${dbarray[i]}"
	if zgrep -q "Dump completed on" ${dbarray[i]}; then 
		echo "$(date +%H:%M:%S) Dump Complete for ${dbarray[i]}" >> /usr/local/mysql-temp/$(date +%d)-dump-complete.log
	else
		echo "$(date +%H:%M:%S) Dump Not Complete for ${dbarray[i]}" >> /usr/local/mysql-temp/$(date +%d)-dump-not-complete.log
	fi
}


##### Create list of backup files.
find /home/mysqlbackup/ -name "*.sql.gz" -type f -mtime -1 > /usr/local/mysql-temp/$(date +%d)-database-list.log


##### Declare array.
declare -a dbarray


##### Load file into array.
readarray dbarray < /usr/local/mysql-temp/$(date +%d)-database-list.log


##### Perform operation. 
let i=0

while (( ${#dbarray[@]} > i )); do
echo "$(date +%H:%M:%S) Entered WHILE loop, starting operation..."
JOBS=$(jobs | wc -l)
echo "$(date +%H:%M:%S) Current number of jobs = $JOBS"

# Change value depending on core
	if [ $JOBS -lt 30 ]
		then
			echo "$(date +%H:%M:%S) Entered IF loop, checking file ${dbarray[i]}..."
	    		check-backup &
			i=$i+1
        else
			echo "$(date +%H:%M:%S) Entered ELSE loop, waiting for jobs to complete..."
			JOBS=$(jobs | wc -l)
			while [ $JOBS -ge 30 ]
				do 
			                echo "$(date +%H:%M:%S) Waiting 10 seconds..."
			                sleep 10
		              		JOBS=$(jobs | wc -l)
					echo "$(date +%H:%M:%S) Number of jobs after sleep = $JOBS"
                		done
			echo "$(date +%H:%M:%S) Checking file from ELSE loop..."
    			check-backup &
			i=$i+1
        fi
done


##### Checking any running jobs

JOBS=$(jobs | wc -l)
while [ $JOBS -gt 0 ]
        do
                echo "$(date +%H:%M:%S) $JOBS jobs waiting to be completed..."
		JOBS=$(jobs | wc -l)
            	jobs
                sleep 10
        done


##### Removing old log files

res=$(echo "$(date +%d) - 5" | bc)
find /usr/local/mysql-temp/ -name $res*.log -type f -exec rm -rf {} \;
echo "$(date +%H:%M:%S) Removed logs older than 5 days"


##### Alerting to Slack channel r1soft-mysql-backups

completed=$(echo "$(cat /usr/local/mysql-temp/$(date +%d)-dump-complete.log | wc -l) / 2" | bc)
ncompleted=$(echo "$(cat /usr/local/mysql-temp/$(date +%d)-dump-not-complete.log | wc -l) / 2" | bc)
list=$(cat /usr/local/mysql-temp/$(date +%d)-dump-not-complete.log)

#To Slack
curl -X POST --data-urlencode "payload={\"channel\": \"#mysql-backups-alert\", \"text\": \"\n\n\n*Failed MySQL Database Report:*\n\n$list\n\n\"}" https://hooks.slack.com/services/xxxxxxxxx/xxxxxxxxx/xxxxxxxxxxxxxxxxxxxxxxxx

curl -X POST --data-urlencode "payload={\"channel\": \"#mysql-backups-alert\", \"text\": \"\n\n\n*Total Complete database backups:* $completed\n\n*Total Incomplete database backups:* $ncompleted\n\n\"}" https://hooks.slack.com/services/xxxxxxxxx/xxxxxxxxx/xxxxxxxxxxxxxxxxxxxxxxxx


echo "###################################################"
echo "$(date +%H:%M:%S) Execution Completed"
echo "Total Complete database backups: $completed\nTotal Incomplete database backups: $ncompleted"
echo "###################################################"
					    </code>
				    </pre>

					<br> 
					<br> 
					<br> 

					<blockquote class="blockquote m-lg-5 py-3   ps-4 px-lg-5">
						<p class="mb-2">Controlling complexity is the essence of computer programming.</p>
						<footer class="blockquote-footer mt-0">Brian Kernighan</footer>
					</blockquote>
				   
			    </div>
				    
				
				<nav class="blog-nav nav nav-justified my-5">
				  <a class="nav-link-prev nav-item nav-link rounded-left" href="#">Previous<i class="arrow-prev fas fa-long-arrow-alt-left"></i></a>
				  <a class="nav-link-next nav-item nav-link rounded-right" href="#">Next<i class="arrow-next fas fa-long-arrow-alt-right"></i></a>
				</nav>
				
		    </div><!--//container-->
	    </article>
	    
	    <footer class="footer text-center py-2 theme-bg-dark">
		   
            <small class="copyright">Designed with <i class="fas fa-heart" style="color: #fb866a;"></i> and passion by Ananda Raj</small>
		   
	    </footer>
    
    </div><!--//main-wrapper-->
    

        
       
    <!-- Javascript -->          
    <script src="assets/plugins/popper.min.js"></script> 
    <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script> 
    
    <!-- Page Specific JS -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>

    <!-- Custom JS -->
    <script src="assets/js/blog.js"></script> 
    

</body>
</html> 

